<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>KiteBlog</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/kiteblog-site/assets/css/0.styles.fae626a7.css" as="style"><link rel="preload" href="/kiteblog-site/assets/js/app.78890177.js" as="script"><link rel="preload" href="/kiteblog-site/assets/js/2.20d80d83.js" as="script"><link rel="preload" href="/kiteblog-site/assets/js/14.c6e8e1f3.js" as="script"><link rel="prefetch" href="/kiteblog-site/assets/js/10.9673d400.js"><link rel="prefetch" href="/kiteblog-site/assets/js/11.2d10b917.js"><link rel="prefetch" href="/kiteblog-site/assets/js/12.fe803248.js"><link rel="prefetch" href="/kiteblog-site/assets/js/13.97915097.js"><link rel="prefetch" href="/kiteblog-site/assets/js/15.a230b438.js"><link rel="prefetch" href="/kiteblog-site/assets/js/16.b56e6d6a.js"><link rel="prefetch" href="/kiteblog-site/assets/js/17.87b4bf6d.js"><link rel="prefetch" href="/kiteblog-site/assets/js/18.64237a67.js"><link rel="prefetch" href="/kiteblog-site/assets/js/19.0f34124a.js"><link rel="prefetch" href="/kiteblog-site/assets/js/20.ea6cbd0a.js"><link rel="prefetch" href="/kiteblog-site/assets/js/21.30cf2dd6.js"><link rel="prefetch" href="/kiteblog-site/assets/js/3.971e59b0.js"><link rel="prefetch" href="/kiteblog-site/assets/js/4.41ad7268.js"><link rel="prefetch" href="/kiteblog-site/assets/js/5.0bd2961b.js"><link rel="prefetch" href="/kiteblog-site/assets/js/6.480c76ed.js"><link rel="prefetch" href="/kiteblog-site/assets/js/7.e9c1f144.js"><link rel="prefetch" href="/kiteblog-site/assets/js/8.d58f241f.js"><link rel="prefetch" href="/kiteblog-site/assets/js/9.350158df.js">
    <link rel="stylesheet" href="/kiteblog-site/assets/css/0.styles.fae626a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/kiteblog-site/" class="home-link router-link-active"><!----> <span class="site-name">KiteBlog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/kiteblog-site/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/kiteblog-site/guide/intro.html" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="https://kite1874.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/kiteblog-site/personal/resume.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简历（求职中...）
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/kiteblog-site/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/kiteblog-site/guide/intro.html" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="https://kite1874.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/kiteblog-site/personal/resume.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简历（求职中...）
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/kiteblog-site/document/node/token" class="sidebar-heading clickable open"><span>Node服务端实现与说明</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/kiteblog-site/document/node/token.html" aria-current="page" class="active sidebar-link">Token 验证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kiteblog-site/document/node/token.html#什么是-token-验证" class="sidebar-link">什么是 Token 验证</a></li><li class="sidebar-sub-header"><a href="/kiteblog-site/document/node/token.html#什么是-jwt-json-web-token" class="sidebar-link">什么是 JWT (JSON WEB TOKEN) ？</a></li><li class="sidebar-sub-header"><a href="/kiteblog-site/document/node/token.html#nodejs-express-中实现-token-的生成和验证" class="sidebar-link">NodeJS (Express) 中实现 Token 的生成和验证</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><code>看文章之前，强烈建议先把项目拉取下来！案例来自小弟的开源项目</code><a href="https://github.com/KiteWorld/KiteBlog" target="_blank" rel="noopener noreferrer">「项目Github」<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>文章内容只是个人学习的一些总结经验，不具有权威性</code></p> <h2 id="什么是-token-验证"><a href="#什么是-token-验证" class="header-anchor">#</a> 什么是 Token 验证</h2> <p>常见的 Token 验证方式种:</p> <ul><li><code>OAuth2</code>，例如：微信授权登录  (貌似也属于 Token 验证)</li> <li><code>基于 JWT 的 Token 验证</code>,<code>KiteBlog</code> 里面使用的就是这种。</li></ul> <p>推荐阅读：</p> <p><a href="https://learnku.com/articles/17883?order_by=vote_count&amp;" target="_blank" rel="noopener noreferrer">JWT 超详细分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.cnblogs.com/fengzheng/p/8416393.html" target="_blank" rel="noopener noreferrer">说一说几种常用的登录认证方式，你用的哪种<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="什么是-jwt-json-web-token"><a href="#什么是-jwt-json-web-token" class="header-anchor">#</a> 什么是 JWT (JSON WEB TOKEN) ？</h2> <p>推荐阅读：</p> <p><a href="http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html" target="_blank" rel="noopener noreferrer">JSON Web Token 入门教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://blog.leapoahead.com/2015/09/06/understanding-jwt/" target="_blank" rel="noopener noreferrer">JSON Web Token - 在Web应用间安全地传递信息<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="nodejs-express-中实现-token-的生成和验证"><a href="#nodejs-express-中实现-token-的生成和验证" class="header-anchor">#</a> NodeJS (Express) 中实现 Token 的生成和验证</h2> <h3 id="安装-jsonwebtoken-和-express-jwt"><a href="#安装-jsonwebtoken-和-express-jwt" class="header-anchor">#</a> 安装 jsonwebtoken 和 express-jwt</h3> <p>首先我们先安装 <code>jsonwebtoken</code>和 <code>express-jwt</code> 这两个中间件</p> <p><code>jsonwebtoken</code>: 用于生成 Token 。它也有解析 Token 的功能</p> <p><code>express-jwt</code>: 用于解析 Token（比 <code>jsonwebtoken</code> 解决方便） , 它把解析之后的数据，存放到 <code>requset.user</code> 中</p> <div class="language- extra-class"><pre class="language-text"><code># 安装 jsonwebtoken
npm i jsonwebtoken

# 安装 express-jwt
npm i express-jwt

</code></pre></div><h3 id="生成-token"><a href="#生成-token" class="header-anchor">#</a> 生成 token</h3> <p>如果你看了上面 JWT 介绍的文章，就知道 JWT 是由三部分组成的，分别是<code>载荷(Payload)</code>、<code>头部(Header)</code>、<code>签名(Signature)</code> 。</p> <p><code>jsonwebtoken</code> 给我们提供了<code>sign(payload, secretOrPrivateKey, [options, callback])</code>方法。sign 方法对应的其实就是 JWT <code>签名(Signature)</code>的动作</p> <p>payload：荷载 ，参数类型：对象
secretOrPrivateKey：自定义的密钥，密钥属于敏感信息。参数类型：字符串
options：可以配置 header 、荷载、指定算法类型。参数类型：对象
callback：回调</p> <p>眼尖的朋友应该发现，<code>payload</code> 和 <code>options</code> 两个<code>参数</code>都可以配置荷，下面有例子。根据自己的习惯选择就好</p> <p>Payload 部分 JWT 规定了7个官方字段,这些字段都是可选字段。可直接以对象的形式传给 <code>payload</code> 参数。</p> <div class="language- extra-class"><pre class="language-text"><code>iss (issuer)：签发人
exp (expiration time)：过期时间
sub (subject)：主题
aud (audience)：受众
nbf (Not Before)：生效时间
iat (Issued At)：签发时间
jti (JWT ID)：编号
</code></pre></div><p><code>options</code> 中也可以接受以上七个字段，不过字段名称有所区别。</p> <div class="language- extra-class"><pre class="language-text"><code>iss ---- issuer
exp ---- expiresIn
sub ---- subject
aud ---- audience
nbf ---- notBefore
iat ---- noTimestamp
jti ---- jwtid
</code></pre></div><p>除此之后 <code>options</code> 提供了<code>algorithm</code>和<code>header</code>，分别对应使用的加密算法和 JWT 的 Header 部分，其实 <code>algorithm</code> 应该也是属于 Header 部分的。</p> <p>说了这么多，其实我们一般常用的只有 <code>exp(expiresIn)</code> 和 <code>algorithm</code> 这两个字段，</p> <p>例子一：</p> <p>token 的有效时间是配置在 <code>option</code>里</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//先引入 jsonwebtoken</span>
<span class="token keyword">var</span> jsonWebToken <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//密钥，当然实际的项目中密钥应该变态一些</span>
<span class="token keyword">const</span> <span class="token constant">SECRET_KEY</span> <span class="token operator">=</span> <span class="token string">'kite1874'</span>

<span class="token keyword">const</span> token <span class="token operator">=</span> jsonWebToken<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	<span class="token comment">// Payload 部分，官方提供七个字段这边省略，可以携带一些可以识别用户的信息。例如 userId。</span>
	<span class="token comment">// 千万不要是用敏感信息，例如密码，Payload 是可以解析出来的。</span>
	userId<span class="token operator">:</span>user<span class="token punctuation">.</span>userId
	role<span class="token operator">:</span>user<span class="token punctuation">.</span>role
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token constant">SECRET_KEY</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
	expiresIn<span class="token operator">:</span><span class="token string">&quot;24h&quot;</span><span class="token punctuation">,</span> <span class="token comment">//token有效期</span>
	<span class="token comment">// expiresIn: 60 * 60 * 24 * 7,  两种写法</span>
	<span class="token comment">// algorithm:&quot;HS256&quot;  默认使用 &quot;HS256&quot; 算法</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
</code></pre></div><p>例子二：</p> <p>我们也可以在 <code>payload</code> 里配置有效时间</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> token <span class="token operator">=</span> jsonWebToken<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	<span class="token comment">//exp 的值是一个时间戳，这里表示 1h 后 token 失效</span>
	exp<span class="token operator">:</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span>
	userId<span class="token operator">:</span>user<span class="token punctuation">.</span>userId
	role<span class="token operator">:</span>user<span class="token punctuation">.</span>role
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token constant">SECRET_KEY</span><span class="token punctuation">)</span>
</code></pre></div><p><code>jsonwebtoken</code> 除了生成 token 外，还提供了解析验证 token 的方法，<code>jwt.verify(token, secretOrPublicKey, [options, callback])</code>。</p> <p>这里就不演示了， 感兴趣的朋友可以参考文档：<a href="https://github.com/auth0/node-jsonwebtoken#token-expiration-exp-claim" target="_blank" rel="noopener noreferrer">「JsonWebToken」<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="验证-token"><a href="#验证-token" class="header-anchor">#</a> 验证 token</h3> <p><code>express-jwt</code> 是针对 <code>express</code>框架开发的 <code>JWT Token</code> 验证中间件。我先来简单说以下它的用法。</p> <p>主要有两种方式，一种是哪些请求需要验证就往哪里加验证；另外一种是先给全部请求加上验证，再给不需要验证的请求配置<code>白名单</code>。</p> <p>方式一：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-jwt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//SECRET_KEY 要与生成 Token 时保持一致 </span>
<span class="token keyword">const</span> <span class="token constant">SECRET_KEY</span> <span class="token operator">=</span> <span class="token string">'kite1874'</span> 

<span class="token comment">// secret 为密钥，algorithms 为算法。需要注意的是，如果你生成 Token 的时候没有手动设置 algorithm </span>
<span class="token comment">// 默认是使用 HS256 来加密的。「express-jwt 6.0」版本需要加 algorithms: ['HS256'] , 说起来都是泪！</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">,</span> 
<span class="token function">jwt</span><span class="token punctuation">(</span><span class="token punctuation">{</span> secret<span class="token operator">:</span> <span class="token constant">SECRET_KEY</span><span class="token punctuation">,</span> algorithms<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'HS256'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//do something...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>看完上面的例子，很显然不符合我们的逾期，一个正常的项目有个几十个 api 是分分钟的事。我们不可能一个个给他加上检验</p> <p>方式二：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//注册中间件，相当于配置一个全局 token 验证，unless 就是上面说的白名单</span>
<span class="token comment">//把不需要 token 验证的请求填进 path 里即可, 支持数组、字符串、正则</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token punctuation">{</span> secret<span class="token operator">:</span> <span class="token constant">SECRET_KEY</span><span class="token punctuation">,</span> algorithms<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'HS256'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">unless</span><span class="token punctuation">(</span><span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/auth/adminLogin'</span><span class="token punctuation">,</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/public\/.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// /auth/adminLogin api 和 public 下的文件都不需要 token 验证</span>
</code></pre></div><p>这种方式是不是方便很多，而且更美观，维护起来也更方便</p> <p><strong>Token 解析出来的用户信息，默认存放在 <code>req.user</code>, 可以直接 <code>req.user.userId</code>来使用生成 Token 时填进去的用户id</strong></p> <p>你也通过 <code>requestProperty</code> 和 <code>resultProperty</code> 来设置用户信息存放的对象。</p> <p>这里就不展开，详细文档参考：<a href="https://github.com/auth0/express-jwt#readme" target="_blank" rel="noopener noreferrer">express-jwt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="验证错误处理"><a href="#验证错误处理" class="header-anchor">#</a> 验证错误处理</h3> <p>可以使用 <code>app.use()</code> 来注册处理验证不通过的情况</p> <div class="language- extra-class"><pre class="language-text"><code>app.use(function (err, req, res, next) {
  if (err.name === 'UnauthorizedError') {
    res.status(401).send(&quot;干嘛呢？你想硬闯？！&quot;)
  }
})
</code></pre></div><h3 id="注意-个人理解-不具有权威性"><a href="#注意-个人理解-不具有权威性" class="header-anchor">#</a> 注意（个人理解，不具有权威性）</h3> <p>到这里 Token 的生成、验证、检验不通过错误处理就完成了。 Token 生成一般是在登录之后生成，并返回给前端，前端拿到 Token ,并在每次请求 api 的时候携带上 Token , Token 就相当于这个用户的身份，不要轻易泄露。</p> <p>Token一旦签发，不能主动让它失效，只能等待它有效期过才能失效。也就是说就算你修改了密码，之前的 Token 也还是有效的。你可以修改后端生成 Token 时使用的密钥，不让之前的 Token 检验通过，但是这就表示之前所有生成 Token 都失效了，做不到针对某个用户进行注销。这显然也不合适的。 所以用户修改密码时，前端一般都要清除之前保存的 Token</p> <p>有朋友应该会想到在后端把 Token 储存起来，每一个用户对应一个 token。修改账号时，再生成一个新的 Token 覆盖之前的 Token，但这就违背了使用 Token 的目的，Token 的使用很大程度就为了减少服务器的压力。把尽可能多的信息存储在客户端而不是服务端。</p> <p>使用 Token 可以防御 CSRF 攻击，之前写过一篇关于网络安全的文章，感兴趣的朋友可以看一下<a href="https://juejin.cn/post/6892961914079412237#comment" target="_blank" rel="noopener noreferrer">「XSS 攻击、CSRF 攻击、SQL 注入、流量劫持（DNS 劫持、HTTP 劫持）—— 浏览器安全」<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/kiteblog-site/assets/js/app.78890177.js" defer></script><script src="/kiteblog-site/assets/js/2.20d80d83.js" defer></script><script src="/kiteblog-site/assets/js/14.c6e8e1f3.js" defer></script>
  </body>
</html>
